---
- name: Add IUS repository to /etc/yum.repos.d/
  yum_repository:
    name: ius
    description: IUS Community Packages for Enterprise Linux
    mirrorlist: https://mirrors.iuscommunity.org/mirrorlist?repo=ius-{{ ansible_distribution|lower}}{{ ansible_distribution_major_version|lower }}&arch=$basearch&protocol=http
    gpgkey: http://dl.iuscommunity.org/pub/ius/IUS-COMMUNITY-GPG-KEY
    enabled: "yes"
    gpgcheck: "yes"
    priority: 15
    state: present
    includepkgs:
      - git2u*
      - yum-plugin-replace

- name: Install base packages
  yum:
    name:
      - "@base"
      - "@development"
      - yum-utils
      - https://dl.fedoraproject.org/pub/epel/epel-release-latest-7.noarch.rpm
    state: latest
  become: true

- name: Swap to git2u
  block:
    - name: Install yum-plugin-replace
      yum:
        name: yum-plugin-replace
        state: present
        update_cache: true
    - name: Gather rpm package facts
      package_facts:
        manager: auto
    - name: Replace git with git2u
      command: yum replace -y git --replace-with git2u
      when: ansible_facts.packages['git'] is defined
  become: true
